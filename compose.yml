# Docker Compose configuration for transceiver-exporter
# A Prometheus exporter for SFP/QSFP transceiver diagnostics
#
# Usage:
#   docker compose up -d
#
# Prerequisites:
#   - Host network mode is REQUIRED (container must see host interfaces)
#   - CAP_NET_ADMIN is REQUIRED (for ethtool ioctl operations)

services:
  transceiver-exporter:
    image: ghcr.io/${GITHUB_REPOSITORY:-local/transceiver-exporter}:latest
    container_name: transceiver-exporter

    # REQUIRED: Host network mode
    # The exporter enumerates interfaces via net.Interfaces() which only sees
    # interfaces in its own network namespace. Bridge mode would only show
    # container-local interfaces (eth0, lo), not host physical NICs.
    network_mode: host

    # Security: Drop all capabilities, add only what's needed
    cap_drop:
      - ALL
    cap_add:
      # REQUIRED: For ethtool ioctl (SIOCETHTOOL) operations
      - NET_ADMIN

    # Security hardening
    security_opt:
      - no-new-privileges:true
    read_only: true

    # Restart policy
    restart: unless-stopped

    # Configuration via command-line arguments
    # Customize these based on your environment
    command:
      - "--web.listen-address=[::]:9458"
      - "--web.telemetry-path=/metrics"
      - "--collector.interface-features.enable=true"
      # Uncomment and customize as needed:
      # - "--collector.optical-power-in-dbm=true"
      # - "--exclude.interfaces=lo,docker0"
      # - "--exclude.interfaces-regex=^(docker|veth|br-).*"
      # - "--include.interfaces=eth0,eth1"
      # - "--exclude.interfaces-down=true"

    # Health check
    # Note: distroless has no shell, wget, or curl
    # Using /dev/tcp requires bash which isn't available
    # For distroless, we rely on container runtime health or external monitoring
    # If using an alpine-based image instead, uncomment:
    # healthcheck:
    #   test: ["CMD", "wget", "-q", "--spider", "http://localhost:9458/metrics"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 10s

    # Resource limits (optional)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 32M

    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
